---
  title: "diversity_global_aquatic_insect"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#1.0 Hill Diversity of well-sampled basin (WSB)
```{r}
library(devtools)
library(iNEXT)
library(iNEXT.3D)

abu=read.csv("Abundances.csv",header = T,row.names = 1,check.names = FALSE)

a=apply(abu, 2, function(x) iNEXT.3D:::Coverage(x, 'abundance', sum(x))) 
mid=median(a)
view(mid)
view(a)

## The iNEXT function takes a significant time to run
# Standardized calculation of taxonomic diversity at mid-point of coverage (nboot need 50)
TD_est=estimate3D(data = abu, diversity = 'TD', q = c(0,1), datatype = 'abundance', base = 'coverage', level = c(mid), nboot = 50)

### Calculation of asymptotic diversity (nboot need 50)
TD_iNEXT=iNEXT3D(abu, diversity = "TD", q = c(0, 1), datatype = "abundance", nboot = 50)
TD_ast=TD_iNEXT$TDAsyEst

write.csv(TD_est,file = "TD_est_mid.csv")
##
#Standardized calculation of functional diversity at mid-point of coverage (nboot need 50)
library(FD)
ex1 <- gowdis(dummy$trait)
traits <- read.csv("Trait.csv", row.names = 1, header= TRUE)

distM <- cluster::daisy(x = traits, metric = "gower") %>% as.matrix()

FD_est <- estimate3D(data = abu, diversity = 'FD', q = c(0, 1), datatype = 'abundance', base = 'coverage',level = c(mid), nboot = 50, FDdistM = distM)

write.csv(FD_est,file = "FD_est_mid.csv")
```


#2.0 Hill Diversity of all basin
```{r}
library(devtools)
library(iNEXT)
library(iNEXT.3D)

abu2=read.csv("all_abu.csv",header = T,row.names = 1,check.names = FALSE)

a2=apply(abu, 2, function(x) iNEXT.3D:::Coverage(x, 'abundance', sum(x))) 
mid2=median(a2)

##Finding the maximum standard error of Standardized taxonomic diversity in WSB
TD_est=estimate3D(data = abu, diversity = 'TD', q = c(0,1), datatype = 'abundance', base = 'coverage', level = c(mid), nboot = 50)
SE_data=TD_est[(TD_est$Order.q=="0"),c(1,5,7)]
max_se=max(SE_data$s.e.)

# Standardized taxonomic diversity in all basins (nboot need 50)
TD_all_est=estimate3D(data = abu2, diversity = 'TD', q = c(0,1), datatype = 'abundance', base = 'coverage', level = c(mid2), nboot = 50)

# Identify basins to be used to study sampling gaps
gap_Basin=TD_all_est[(TD_all_est$Order.q=="0" & TD_all_est$s.e. < max_se),c(1,5,7)]

#  Calculation of asymptotic diversity of all basin (no need 50)
all_TD_iNEXT=iNEXT3D(abu2, diversity = "TD", q = c(0, 1), datatype = "abundance", nboot = 50)
all_TD_ast=all_TD_iNEXT$TDAsyEst

# Ratio of observed to predicted diversity
gap_TD_ast=all_TD_ast[which(all_TD_ast$`Taxonomic Diversity` =="Species richness" &  all_TD_ast$Assemblage %in% gap_Basin$Assemblage),]
all_TD_q1_mid=TD_all_est[(TD_est$Order.q=="0"& TD_est$SC==mid ),c(1,5)]
pro=all_TD_q1_mid[which(all_TD_q1_mid$Assemblage %in% gap_TD_ast$Assemblage ),]
pro_merge=merge(gap_TD_ast,pro, by="Assemblage")
pro_merge$proportion=pro_merge$`Taxonomic Observed`/pro_merge$qTD
count <- sum(pro_merge$proportion > 1)

write.csv(pro_merge,file="mid2_01.csv")
```


#3.0 Observed TD FD
```{r}
library(vegan)
abu=read.csv("Abundances.csv",header = T,row.names = 1,check.names = FALSE)
spm=t(abu)

SR=specnumber(spm)
SR=data.frame(SR)

shannon=diversity(spm,index = "shannon")
SH=data.frame(shannon)

TD_observe=data.frame(SR,SH)

traits <- read.csv("Trait.csv",  header= TRUE)
trm.s=traits[which(traits$genus %in% colnames(spm)),]

row.names(trm.s) <- trm.s$genus
trm.s <- trm.s[, -1]

library(FD)
FD <- dbFD(trm.s, spm)

FD_reslut=data.frame(FD$FRic,FD$FEve,FD$FDiv,FD$FDis,FD$RaoQ)

write.csv(FD_reslut,file = "FD_reslut.csv")


FD_observe=read.csv("FD_reslut.csv",header = T)
obesrve=data.frame(TD_observe,FD_observe)
#####   MergeBio
TD_est=read.csv("TD_est_mid.csv")
TDq0=TD_est[(TD_est$Order.q=="0"),c(2,6)]
TDq1=TD_est[(TD_est$Order.q=="1"),c(2,6)]

FD_est=read.csv("FD_est_mid.csv")
FDq0=FD_est[(FD_est$Order.q=="0"),c(2,6)]
FDq1=FD_est[(FD_est$Order.q=="1"),c(2,6)]

merged1 <- merge(TDq0, TDq1, by = "Assemblage", all = TRUE)
merged2 <- merge(merged1, FDq0, by = "Assemblage", all = TRUE)
merged3 <- merge(merged2, FDq1, by = "Assemblage", all = TRUE)

colnames(merged3)[1] <- "HYBAS_ID"
colnames(merged3)[2] <- "TDq0"
colnames(merged3)[3] <- "TDq1"
colnames(merged3)[4] <- "FDq0"
colnames(merged3)[5] <- "FDq1"

Proportion=read.csv("TD_proportion.csv",header = T)
por=Proportion[,c(2,4,5)]
colnames(por)[1] <- "HYBAS_ID"

obesrve$HYBAS_ID <- rownames(obesrve)
obesrve <- obesrve[, c("HYBAS_ID", names(obesrve)[-ncol(obesrve)])]

TDFD=merge(merged3,por, by = "HYBAS_ID", all = TRUE)
Bio=merge(TDFD,obesrve, by = "HYBAS_ID", all = TRUE)

write.csv(Bio,file="Bio_all.csv")
```

